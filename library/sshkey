#!/usr/bin/python

import os

def main():
    module = AnsibleModule(
       argument_spec = dict(
           dest=dict(type='str', required=True),
           pub_mode=dict(type='str', required=False),
           state=dict(type='str', choices=['absent', 'present'], default='present'),
       ),
       add_file_common_args=True,
       supports_check_mode=True,
    )

    changed = False
    sshkeygen = module.get_bin_path('ssh-keygen', True)

    dest = module.params['dest']
    pubkey = None

    if module.params['state'] == 'present':
        if not os.path.exists(dest):
            if module.check_mode:
                module.exit_json(changed=True)
            module.run_command('%s -f %s -N ""'%(sshkeygen, dest))
            changed=True

        file_args = module.load_file_common_arguments(module.params)

        pub_args = file_args.copy()
        pub_args['path'] = pub_args['path'] + '.pub'
        if module.params['pub_mode'] is not None:
            pub_args['mode'] = module.params['pub_mode']

        changed = module.set_fs_attributes_if_different(file_args, changed)

        changed = module.set_fs_attributes_if_different(pub_args, changed)

        with open(pub_args['path'], 'r') as f:
            pubkey = f.read()


    if module.params['state'] == 'absent':
        if os.path.exists(dest):
            if not module.check_mode:
                os.remove(dest)
            changed = True

    module.exit_json(changed=changed,pubkey=pubkey)


# this is magic, see lib/ansible/module_common.py
#<<INCLUDE_ANSIBLE_MODULE_COMMON>>
main()
